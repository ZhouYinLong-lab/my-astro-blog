---
import { Image } from "astro:assets";
import { t } from "@config";
import type { PostData } from "@interfaces/data";
import { Icon } from "astro-icon/components";
import Card from "@/components/temple/Card.astro";

export interface MainCardProps extends PostData {
  infoIcon?: string;
  helpText?: string;
  textOverlay?: string;
  showTextBackground?: boolean;
  headerClass?: string;
  extraClasses?: string;
  link?: string; // ğŸ‘‰ æ¥æ”¶æˆ‘ä»¬è‡ªå®šä¹‰çš„ link å­—æ®µ
}

const {
  title,
  description,
  image,
  infoIcon = "lucide:help-circle",
  helpText = t("label.learnMore"),
  textOverlay,
  showTextBackground = true,
  headerClass = "",
  extraClasses = "",
  link, // ğŸ‘‰ æå– link å­—æ®µ
} = Astro.props as MainCardProps;

const accessibleHelpText = `${helpText}: ${title}`;
---

<Card class={`overflow-hidden ${extraClasses}`}>
  {
    image ? (
      <div class="relative group">
        {/* ğŸ‘‰ æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæœ‰ link,å°±æŠŠå›¾ç‰‡å˜æˆå¸¦æ‚¬æµ®ç‰¹æ•ˆçš„è¶…é“¾æ¥ */}
        {link ? (
          <a 
            href={link} 
            target="_blank"
            class="block aspect-video w-full overflow-hidden relative cursor-pointer"
          >
            <Image
              src={image}
              alt={title}
              width={1200}
              height={630}
              format="webp"
              loading="eager"
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
            />
            {/* æ‚¬æµ®é»‘è‰²åŠé€æ˜é®ç½©ä¸è·³è½¬å›¾æ ‡ */}
            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-all duration-300 flex items-center justify-center">
              <Icon name="lucide:external-link" class="w-16 h-16 text-white opacity-0 group-hover:opacity-100 transition-all duration-300 transform scale-50 group-hover:scale-100 drop-shadow-lg" />
            </div>
          </a>
        ) : (
          <div class="aspect-video w-full overflow-hidden">
            <Image
              src={image}
              alt={title}
              width={1200}
              height={630}
              format="webp"
              loading="eager"
              class="w-full h-full object-cover"
            />
          </div>
        )}

        <div class="absolute bottom-4 left-4 right-4 lg:bottom-6 lg:left-6 lg:right-6 flex items-end justify-between gap-4 pointer-events-none">
          <div class="inline-block bg-black/60 backdrop-blur-md px-4 py-2 rounded-xl border border-white/40 shadow-lg pointer-events-auto">
            <h1 class="text-xl sm:text-2xl lg:text-4xl font-bold text-white">{title}</h1>
          </div>

          {description && (
            <div class="flex-shrink-0 pointer-events-auto">
              <div class="dropdown dropdown-top dropdown-end dropdown-hover">
                <label
                  tabindex="0"
                  aria-label={accessibleHelpText}
                  class="group btn btn-sm px-2 bg-black/60 backdrop-blur-md hover:bg-black/80 border border-white/40 text-white shadow-lg rounded-full flex items-center gap-0 transition-all duration-300 ease-in-out"
                >
                  <Icon name={infoIcon} class="w-4 h-4 flex-shrink-0" />
                  <span class="w-0 overflow-hidden group-hover:w-20 transition-all duration-300 text-xs whitespace-nowrap">
                    {helpText}
                  </span>
                </label>
                <div
                  tabindex="0"
                  class="dropdown-content z-[1] card w-64 sm:w-80 p-2 shadow-lg bg-black/70 backdrop-blur-md text-white border border-white/20 mb-4"
                  data-state="closed"
                >
                  <div class="card-body p-3">
                    <p class="text-sm">{description}</p>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    ) : textOverlay ? (
      <div class="relative group">
        <div class={`aspect-video w-full overflow-hidden bg-gradient-to-br from-base-300 to-base-100 ${headerClass}`}>
          {showTextBackground && textOverlay && (
            <div class="absolute inset-0 w-full h-full error-animation-container">
              <div class="text-9xl md:text-[12rem] font-bold text-primary opacity-20 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                {textOverlay}
              </div>
            </div>
          )}
        </div>
        <div class="absolute bottom-4 left-4 right-4 lg:bottom-6 lg:left-6 lg:right-6 flex items-end justify-between gap-4">
          <div class="inline-block bg-black/60 backdrop-blur-md px-4 py-2 rounded-xl border border-white/40 shadow-lg">
            <h1 class="text-xl sm:text-2xl lg:text-4xl font-bold text-white">{title}</h1>
          </div>
        </div>
      </div>
    ) : (
      <div class="pt-6 px-6">
        <h1 class="text-xl sm:text-2xl lg:text-4xl font-bold">{title}</h1>
        {description && <p class="mt-2 text-sm text-base-content/80">{description}</p>}
      </div>
    )
  }

  <div class="p-4 sm:p-6 relative z-10 bg-base-100">
    <slot />
  </div>
</Card>

<script>
  document.addEventListener("astro:page-load", () => {
    const infoButtons = document.querySelectorAll(".dropdown label");
    const dropdownContents = document.querySelectorAll(".dropdown-content");

    infoButtons.forEach((button, index) => {
      button.addEventListener("click", () => {
        const content = dropdownContents[index];
        const currentState = content.getAttribute("data-state");

        if (currentState === "closed") {
          content.setAttribute("data-state", "open");
          content.classList.add("scale-100", "opacity-100");
          content.classList.remove("scale-90", "opacity-0");
        } else {
          content.setAttribute("data-state", "closed");
          content.classList.add("scale-90", "opacity-0");
          content.classList.remove("scale-100", "opacity-100");
        }
      });
    });
  });
</script>