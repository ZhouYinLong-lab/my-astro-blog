---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";

const allPosts = await getCollection(
  "blog",
  ({ data }: CollectionEntry<"blog">) => {
    return import.meta.env.PROD ? !data.draft : true;
  },
);
const articleCount = allPosts.length;
let lastUpdateStr = "åˆšåˆš";

if (articleCount > 0) {
  const sortedPosts = allPosts.sort(
    (a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
      b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
  );
  const latestDate = new Date(sortedPosts[0].data.pubDate);
  const today = new Date();
  const diffTime = Math.abs(today.getTime() - latestDate.getTime());
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  if (diffDays === 0) {
    lastUpdateStr = "ä»Šå¤©";
  } else {
    lastUpdateStr = `${diffDays} å¤©å‰`;
  }
}

// ğŸ‘‡ æ˜¾éšé€»è¾‘ï¼šç²¾å‡†æ¢æµ‹å½“å‰ç½‘å€
const pathname = decodeURI(Astro.url.pathname);

// å®šä¹‰å…è®¸æ˜¾ç¤ºçš„é¡µé¢è·¯å¾„
const isHomePage = pathname === "/" || pathname === "/index.html";
const isBlogPage = pathname === "/blog" || pathname === "/blog/";
// æ³¨æ„ï¼šå¦‚æœä½ çš„â€œå±…å£«è‡ªåºâ€æˆ–â€œå‹é“¾â€ç½‘å€åç¼€ä¸æ˜¯ about å’Œ friendsï¼Œè¯·ä¿®æ”¹ä¸‹é¢å•å¼•å·é‡Œçš„è¯ï¼
const isAboutPage = pathname.includes("/about");
const isFriendsPage =
  pathname.includes("/friends") || pathname.includes("/links");

// ç»¼åˆåˆ¤å®š
const shouldShow = isHomePage || isBlogPage || isAboutPage || isFriendsPage;
---

{/* ğŸ‘‡ åªæœ‰åˆ¤å®šé€šè¿‡ï¼Œæ‰æ¸²æŸ“è¿™å— UI é¢æ¿ */}
{shouldShow && (
  <div class="card bg-base-100 shadow-sm border border-base-200 p-5 mt-4">
    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-base-content">
      <Icon name="lucide:line-chart" class="w-5 h-5 text-primary" />
      <span>ç½‘ç«™ä¿¡æ¯</span>
    </h2>
    
    <div class="flex flex-col gap-3 text-sm">
      <div class="flex justify-between items-center">
        <span class="text-base-content/80">æ–‡ç« æ•°ç›®ï¼š</span>
        <span class="font-mono text-base-content">{articleCount}</span>
      </div>
      
      <div class="flex justify-between items-center">
        <span class="text-base-content/80">æœ¬ç«™è®¿å®¢æ•°ï¼š</span>
        <span class="font-mono text-base-content" id="busuanzi_value_site_uv">
          <span class="loading loading-spinner loading-xs text-primary/50"></span>
        </span>
      </div>
      
      <div class="flex justify-between items-center">
        <span class="text-base-content/80">æœ¬ç«™æ€»æµè§ˆé‡ï¼š</span>
        <span class="font-mono text-base-content" id="busuanzi_value_site_pv">
          <span class="loading loading-spinner loading-xs text-primary/50"></span>
        </span>
      </div>
      
      <div class="flex justify-between items-center">
        <span class="text-base-content/80">æœ€åæ›´æ–°æ—¶é—´ï¼š</span>
        <span class="font-mono text-base-content">{lastUpdateStr}</span>
      </div>
    </div>
  </div>
)}

{/* ğŸ‘‡ ç»Ÿè®¡è„šæœ¬å¿…é¡»ç•™åœ¨å¤–é¢ï¼Œç¡®ä¿å…¨ç«™è®¡æ•°æ­£å¸¸è¿è¡Œ */}
<script is:inline async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" data-astro-rerun></script>