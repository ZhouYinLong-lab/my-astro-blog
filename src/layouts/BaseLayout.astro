---
import { ClientRouter } from "astro:transitions";
import Footer from "@components/Footer.astro";
import Header from "@components/Header.astro";
import Navbar from "@components/Navbar.astro";
import Sidebar from "@components/Sidebar.astro";
import MobileTOC from "@components/widgets/MobileTOC.astro";
import {
  SITE_DESCRIPTION,
  SITE_FAVICON,
  SITE_LANGUAGE,
  SITE_TAB,
  SITE_THEME,
} from "@config";
import ElementCrossing from "astro-vtbot/components/ElementCrossing.astro";
import PointerOnNavigation from "astro-vtbot/components/PointerOnNavigation.astro";

const {
  title,
  image,
  bgImage = "/background/15.webp",
  animateType = "fade-up", // ğŸ‘ˆ æ–°å¢ï¼šé»˜è®¤ä¸ºæ–‡ç« é¡µçš„å‘ä¸Šæµ®ç°åŠ¨ç”»
  description = SITE_DESCRIPTION,
  headings = [],
  showTOC = false,
  isIndexed = true,
} = Astro.props;
---

<!doctype html>
<html lang={SITE_LANGUAGE} class="bg-base-300" data-theme={SITE_THEME.light} data-theme-type="light">
  <head>
    <ClientRouter />
    <ElementCrossing />
    <PointerOnNavigation />
    <Header title={title} description={description} favicon={SITE_FAVICON} image={image} />
    <title>{`${title} - ${SITE_TAB}`}</title>
    
    {/* å¼ºåˆ¶æµè§ˆå™¨æœ€é«˜ä¼˜å…ˆçº§é¢„åŠ è½½èƒŒæ™¯å›¾ */}
    {bgImage && <link rel="preload" as="image" href={bgImage} fetchpriority="high" />}

    <script define:vars={{ SITE_THEME }} is:inline>
      (function () {
        const storedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        let theme;
        if (storedTheme) {
          theme = storedTheme;
        } else {
          theme = prefersDark ? SITE_THEME.dark : SITE_THEME.light;
          localStorage.setItem("theme", theme);
        }
        document.documentElement.setAttribute("data-theme", theme);
        const themeType = theme === SITE_THEME.dark ? "dark" : "light";
        document.documentElement.setAttribute("data-theme-type", themeType);
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
          if (!localStorage.getItem("theme")) {
            const newTheme = e.matches ? SITE_THEME.dark : SITE_THEME.light;
            document.documentElement.setAttribute("data-theme", newTheme);
            const newThemeType = e.matches ? "dark" : "light";
            document.documentElement.setAttribute("data-theme-type", newThemeType);
            localStorage.setItem("theme", newTheme);
          }
        });
      })();
    </script>
  </head>

  <body class="flex flex-col min-h-screen relative" {...isIndexed ? { "data-pagefind-body": true } : {}}>
    
    {/* èµ›åšåº•å±‚ç”»æ¡†ï¼šå¼€å¯ transform-gpu å¼ºåˆ¶æ˜¾å¡åŠ é€Ÿæ¸²æŸ“æ¯›ç»ç’ƒ */}
    {bgImage && (
      <div class="fixed inset-0 z-[-10] pointer-events-none transform-gpu">
        <div 
          class="absolute inset-0 bg-cover bg-center bg-no-repeat transition-opacity duration-1000"
          style={`background-image: url('${bgImage}');`}
        ></div>
        <div class="absolute inset-0 bg-base-300/30 backdrop-blur-[4px]"></div>
      </div>
    )}

    <Navbar />

    {/* ğŸ‘‡ æ–°å¢ï¼šè¿™é‡ŒåŠ¨æ€ç»‘å®šäº†åŠ¨ç”»ç±»å‹ animate-cinematic æˆ–æ˜¯ animate-fade-up */}
    <div class={`max-w-6xl mx-auto w-full flex-grow animate-${animateType}`}>
      <div class="grid grid-cols-1 md:grid-cols-5 lg:grid-cols-4 gap-4 p-4 h-full">
        <main
          class="col-span-1 md:col-span-4 lg:col-span-3 bg-transparent order-1 md:order-2 mt-16 md:mt-0 flex flex-col gap-4"
        >
          <div class="flex-grow flex flex-col gap-4">
            <slot />
          </div>
          <Footer />
        </main>
        <aside class="col-span-1 bg-transparent order-2 md:order-1 md:top-4">
          <Sidebar headings={headings} showTOC={showTOC} />
          <slot name="sidebar" />
        </aside>
      </div>
    </div>

    <MobileTOC headings={headings} showTOC={showTOC} />

    <script define:vars={{ SITE_THEME }} is:inline>
      document.addEventListener("astro:after-swap", () => {
        const storedTheme = localStorage.getItem("theme");
        if (storedTheme) {
          document.documentElement.setAttribute("data-theme", storedTheme);
          const themeType = storedTheme === SITE_THEME.dark ? "dark" : "light";
          document.documentElement.setAttribute("data-theme-type", themeType);
        }
      });
    </script>

    <script is:inline>
      document.addEventListener("astro:page-load", () => {
        // äº‹ä»¶å§”æ‰˜ï¼šåªåœ¨ document.body ä¸Šç»‘å®šä¸€æ¬¡ç›‘å¬å™¨ï¼Œæ¶ˆç­ TBT é˜»å¡
        document.body.addEventListener("click", async (e) => {
          const button = e.target.closest(".btn-copy");
          if (!button) return; 

          const codeBlock = button.closest(".frosti-code");
          if (!codeBlock) return;
          const codeNode = codeBlock.querySelector("code");
          if (!codeNode) return;

          const code = codeNode.textContent;
          const copyIcon = button.querySelector(".frosti-code-toolbar-copy-icon");
          const successIcon = button.querySelector(".frosti-code-toolbar-copy-success");
          
          try {
            await navigator.clipboard.writeText(code);
            if(copyIcon) copyIcon.classList.add("hidden");
            if(successIcon) successIcon.classList.remove("hidden");
            button.classList.add("copy-success");
            
            setTimeout(() => {
              if(copyIcon) copyIcon.classList.remove("hidden");
              if(successIcon) successIcon.classList.add("hidden");
              button.classList.remove("copy-success");
            }, 2000);
          } catch (err) {
            console.error("Failed to copy:", err);
          }
        });
      });
    </script>

    {/* ğŸ‘‡ å…³é”®ï¼šæŠŠ loading å…œåº•å’Œä¸¤å¥—å…¥åœºåŠ¨ç”»ç”¨ style is:global åŒ…è£¹èµ·æ¥ */}
    <style is:global>
      /* --- ä½ ä¹‹å‰çš„ä»£ç å¤åˆ¶æŒ‰é’®åŠ¨ç”» --- */
      .btn-copy {
        position: relative;
        overflow: hidden;
      }
      .copy-success {
        animation: pulse 0.5s ease-in-out;
      }
      .frosti-code-toolbar-copy-success svg {
        color: #10b981;
      }
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
      }

      /* ================= å…¨å±€å›¾ç‰‡ Loading å…œåº•é­”æ³• ================= */
      img {
        /* åœ¨å›¾ç‰‡æœªåŠ è½½å‡ºæ¥æ—¶ï¼Œå±…ä¸­æ˜¾ç¤ºä½ çš„ gif åŠ¨å›¾ */
        background: url('/img/loading.gif') no-repeat center center;
        /* å¼ºè¡Œé™åˆ¶ gif çš„å¤§å°ï¼Œé˜²æ­¢å®ƒè·Ÿç€å¤–é¢å¤§å›¾çš„å°ºå¯¸è¢«æ‹‰ä¼¸å¾—ç•¸å½¢ */
        background-size: 40px 40px; 
        /* ç»™æœªåŠ è½½çš„å›¾ç‰‡åŒºåŸŸé“ºä¸€å±‚ææš—çš„åº•è‰²ï¼Œæ˜¾å¾—æ›´æœ‰éª¨æ¶æ„Ÿ */
        background-color: rgba(128, 128, 128, 0.05); 
      }

      /* ================= é¦–é¡µï¼šç”µå½±çº§å¯¹ç„¦å¼€åœº ================= */
      .animate-cinematic {
        animation: cinematic-intro 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      }
      @keyframes cinematic-intro {
        0% { opacity: 0; filter: blur(12px); transform: scale(0.96); }
        100% { opacity: 1; filter: blur(0); transform: scale(1); }
      }

      /* ================= æ–‡ç« é¡µï¼šæ°´å¢¨èˆ¬å‘ä¸Šæµ®ç° ================= */
      .animate-fade-up {
        animation: fade-up 0.8s ease-out forwards;
      }
      @keyframes fade-up {
        0% { opacity: 0; transform: translateY(20px); }
        100% { opacity: 1; transform: translateY(0); }
      }
    </style>
  </body>
</html>